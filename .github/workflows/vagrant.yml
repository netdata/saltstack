---
# CI code for testing SaltStack Netdata scripts
name: SaltStack
on:
  push:
    branches:
      - develop

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
       matrix: ${{ steps.setmatrix.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: Set Dynamic Matrix
        id: setmatrix
        run: |
          import yaml
          x = {}
          with open('servers.yml') as fh:
            runs = []
            read_data = yaml.safe_load(fh)
            for i in read_data:
              s = {}
              s['image'] = i['name']
              runs.append(s)
          x['include'] = runs
          print(f'::set-output name=matrix::{x}')
        shell: python
  Test:
    name: Test Salt
    runs-on: macos-10.15
    needs: setup
    strategy:
      matrix: ${{ fromJson(needs.setup.outputs.matrix) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: Create ${{ matrix.image }}
        run: |
          vagrant up ${{ matrix.image }}
      - name: Cleanup
        if: always()
        run: |
          vagrant destroy ${{ matrix.image }} -f
